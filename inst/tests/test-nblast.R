context("Blasting")

fc_download_data('http://jefferislab.org/si/nblast/flycircuit/kcs20scores.desc', type='bigmat', quiet=TRUE)
library(nat)
kcs20 <- read.neuronlistfh('http://jefferislab.org/si/nblast/flycircuit/kcs20.rds', getOption('flycircuit.datadir'), quiet=TRUE)

test_that("fc_nblast returns correct scores", {
  scores <- fc_nblast(names(kcs20[1:5]), names(kcs20[1:5]), 'kcs20scores')
  expectedscores <- structure(c(0, 0.879701774928044, 1.09036313166767, 0.856098554157773, 1.02160805621394, 0.879701774928044, 0, 1.02431095296207, 1.00101232979235, 0.978638909712389, 1.09036313166767, 1.02431095296207, 0, 0.904209455784958, 0.526020923421957, 0.856098554157773, 1.00101232979235, 0.904209455784958, 0, 0.928713797099109, 1.02160805621394, 0.978638909712389, 0.526020923421957, 0.928713797099109, 0), .Dim = c(5L, 5L), .Dimnames = list(c("FruMARCM-M001205_seg002", "GadMARCM-F000122_seg001", "GadMARCM-F000050_seg001", "GadMARCM-F000142_seg002", "FruMARCM-F000270_seg001"), c("FruMARCM-M001205_seg002", "GadMARCM-F000122_seg001", "GadMARCM-F000050_seg001", "GadMARCM-F000142_seg002", "FruMARCM-F000270_seg001")))

  expect_equal(scores, expectedscores)
})

test_that('',{
  scores=structure(c(0, 2845.4317402821, 3526.82460318369, 2769.08614741558, 
  3304.43347066887, 3313.81077882942, 3331.70011486235, 3363.26403318944, 
  3199.75383427718, 3414.01959580793, 3197.04749844765, 2994.37394979852, 
  3581.79847783985, 3572.34500830339, 3168.04096166487, 3503.29589024533, 
  2346.76407804497, 2084.2159189105, 2250.31084470027, 3232.8017756689, 
  2975.68037628093, 0, 3464.83557133685, 3386.02561808177, 3310.3452580101, 
  3490.22582012957, 3802.88905745666, 3400.97753902975, 3599.28631165917, 
  3181.39985176839, 2977.73087203722, 2259.46240088896, 3291.17996216597, 
  3369.45116090102, 3659.31802952112, 3781.54362423248, 2317.83603050091, 
  2556.59846653361, 2660.73691374607, 3335.39056768109, 4644.4802872912, 
  4363.12627501678, 0, 3851.54529808104, 2240.62400734273, 3249.08606720952, 
  3051.0122664085, 3109.2275234932, 4235.1671443025, 1355.05878424146, 
  4594.01912635425, 4418.36451657576, 1548.61691632296, 1558.24498425646, 
  2409.01351341648, 2819.09746745729, 4402.66680475817, 4220.58549640994, 
  4447.70517203969, 2188.2380174536, 3461.35768426947, 4047.26967817854, 
  3655.87855833895, 0, 3754.95393896395, 4160.09952476798, 3915.33223246082, 
  2562.90588073, 2143.97761555295, 3671.57873091063, 3567.91568988159, 
  2977.99673123217, 3932.56644767734, 3992.14869295653, 3528.61466016449, 
  3744.40968453536, 3305.61555098827, 3169.55118770211, 2736.40843680582, 
  3366.82637324565, 4293.43644604511, 4112.85319934588, 2210.6691409344, 
  3903.03662951464, 0, 2783.58874416463, 2289.99627656925, 3929.05460833303, 
  4030.40546985475, 1780.87717037761, 4312.48998643327, 3864.16858139438, 
  1754.44468476778, 1956.98520600668, 2109.95119376992, 2642.03956558839, 
  3868.31443811902, 4277.4950454096, 4229.25060292701, 1404.61147852955, 
  4679.00747292464, 4712.39243727932, 3483.64575655352, 4699.15467445623, 
  3024.98397401089, 0, 2277.62295574436, 5015.30616212824, 4408.18970072605, 
  3242.18110302924, 4058.45789554826, 4235.64419392422, 3377.89797352373, 
  3574.985347975, 2099.77821061541, 3078.56418173015, 3417.56550658869, 
  4948.94904206316, 4414.38336265418, 2440.80699237929, 4845.04277266954, 
  5288.1925277091, 3369.16595194308, 4555.02031551075, 2563.05816320623, 
  2345.78124868434, 0, 4975.10006087972, 4206.94026178748, 2968.19859119523, 
  4710.4825662405, 4827.48713051171, 2987.10338669448, 3034.05714337745, 
  1538.18796862654, 2816.47949985024, 4204.88603653917, 5294.28400820755, 
  5151.31451977521, 2316.81738295826, 4914.62878089302, 4752.20767238163, 
  3450.07866911679, 2996.0730718393, 4418.85545381628, 5190.40413287586, 
  4999.19255512127, 0, 3880.48637428764, 3514.72321910723, 5234.97732310113, 
  4654.63306712567, 3684.34331997316, 3510.70164383152, 4589.19392984708, 
  4940.24008272227, 4884.30148390258, 3710.19694817592, 4159.73844332724, 
  4300.67823228624, 4709.49684059106, 5065.66221640921, 4733.42210245573, 
  2524.45815014404, 4565.60836422571, 4595.07056085658, 4257.8717419544, 
  3908.53808301743, 0, 4631.99318845924, 3514.81037251846, 4075.14408058666, 
  4725.60323626204, 4755.75963816187, 4035.75844781839, 3674.65698806285, 
  4163.70684067781, 4151.72557453085, 4161.42008641544, 4050.98462286236, 
  5241.24135131076, 4670.33782953205, 1579.69419767186, 4509.31923007615, 
  2104.23427177409, 3525.16449107418, 3133.49778634654, 3692.57668320663, 
  4831.45700997184, 0, 5165.61746747546, 4772.88418172488, 1533.61363540284, 
  1698.80557468023, 2780.65093306622, 3298.27375547366, 4978.77937686706, 
  4861.54793062844, 4927.92000020945, 2438.82912989746, 5099.51590421403, 
  4541.79153209718, 5564.41354074458, 4552.86142962356, 5294.19502399532, 
  4584.74171242733, 5166.70363803134, 5714.32464425256, 3809.11267643747, 
  5367.02915772106, 0, 3547.0444763575, 5447.47107684407, 5334.76028802658, 
  4731.66142348759, 3943.8843583616, 3353.42487794348, 4453.18237518531, 
  3539.51649319815, 4829.64676727441, 4818.41160231663, 3476.68120271465, 
  5398.91065260727, 3833.64649626225, 4785.7047200467, 4827.15560255204, 
  5341.79568678899, 5125.70436548537, 4455.3608727945, 5002.77080515658, 
  3578.36495738494, 0, 5308.57373560612, 5351.36785396857, 5106.31595094227, 
  5406.46964027324, 2632.04649915197, 3394.99077073814, 3016.92640279129, 
  4340.57507500212, 5788.89261031159, 5086.36903243832, 1900.57530639636, 
  5084.64225206733, 2182.35802251602, 3866.47174525535, 3319.80739586626, 
  4074.97249124743, 5189.11934316812, 1614.51527213281, 5519.6230116367, 
  5331.80600578382, 0, 1491.67928143305, 3094.70230728631, 3676.59198075073, 
  5332.87197906523, 5316.5783626834, 5362.8740347198, 2579.55123556337, 
  5748.45658026285, 5184.64370549415, 1904.0587107091, 5139.18859910179, 
  2423.69170500014, 4074.23517213111, 3357.29809811984, 3866.00156923134, 
  5199.47883885161, 1780.62877896529, 5381.86633913498, 5351.36785396857, 
  1485.17958957495, 0, 3227.52894710921, 3588.97922810992, 5295.56071881065, 
  4773.7451439864, 5111.01828766851, 2930.63555025432, 5365.59050197466, 
  5926.37027676653, 3098.2232619073, 4781.02437053274, 2750.36998429088, 
  2518.68658181051, 1791.44894166917, 5319.04163917216, 4644.01869234605, 
  3067.64472202947, 5024.12614723516, 5374.48134005084, 3243.03226536975, 
  3397.0271850318, 0, 2857.6768052464, 4638.98849102626, 5874.9602259383, 
  5633.82174544851, 2113.66116210298, 5970.40567210825, 6162.51553578626, 
  3648.24378141531, 5105.05433046511, 3465.43943020266, 3715.77322682641, 
  3300.66846955815, 5761.62939768091, 4254.86598617803, 3661.38646249828, 
  4213.77489944154, 5725.88907197429, 3876.84208863475, 3801.019576379, 
  2875.50015330407, 0, 5341.17749326626, 6176.01913960332, 5650.20775658562, 
  2987.81778888187, 4090.31062898683, 3863.06005083485, 5827.05900629758, 
  4609.23858518082, 5189.20229503771, 4218.69058793367, 5039.75445057358, 
  5825.853577185, 4930.70546922372, 5652.51328336971, 3664.33844278592, 
  2850.90375728715, 5751.13644801152, 5735.89180702685, 4774.01102506861, 
  5462.5678908405, 0, 3904.81868687476, 2968.69411981342, 4356.21025233286, 
  3500.60208915602, 4106.05208261458, 5382.93925611642, 4258.80539868706, 
  5529.44481479777, 5886.90447148162, 6114.7057431356, 4264.49143199979, 
  4737.7346867254, 5318.71184153616, 4689.11256724811, 3543.56804735687, 
  5525.07163180824, 4982.66178048471, 5826.10400784318, 6086.69654874129, 
  3762.82528007932, 0, 2782.07991958467, 5433.65070359954, 4009.35664583922, 
  4533.10733453035, 6017.4834680537, 3900.34554654576, 5799.46017637145, 
  5570.26928055615, 6311.29575546309, 5071.87386102068, 5037.5085256608, 
  5719.09981675684, 3953.63210940015, 3340.40428842974, 5912.01364176082, 
  5659.02681304215, 5926.63992348637, 5907.03538188497, 3034.66510025372, 
  2951.22104677116, 0, 5392.33679261192, 5577.72137351324, 5502.83292311021, 
  2866.94285709162, 4647.16879687427, 1865.20223436173, 2982.53223507694, 
  2748.76638656065, 5077.90923812111, 4748.76187847501, 2740.88594873797, 
  5224.12122729462, 4654.0082861073, 2753.76929286722, 3142.25693572126, 
  2153.20991565584, 3024.8568523804, 4312.20812857192, 5581.73762004985, 
  5221.82811932775, 0), .Dim = c(20L, 20L), .Dimnames = list(c("FruMARCM-M001205_seg002", 
  "GadMARCM-F000122_seg001", "GadMARCM-F000050_seg001", "GadMARCM-F000142_seg002", 
  "FruMARCM-F000270_seg001", "FruMARCM-F001115_seg002", "FruMARCM-M001051_seg002", 
  "GadMARCM-F000423_seg001", "ChaMARCM-F000586_seg002", "FruMARCM-M001339_seg001", 
  "GadMARCM-F000476_seg001", "FruMARCM-F000085_seg001", "FruMARCM-F000706_seg001", 
  "FruMARCM-M000842_seg002", "FruMARCM-F001494_seg002", "FruMARCM-F000188_seg001", 
  "GadMARCM-F000071_seg001", "FruMARCM-M000115_seg001", "GadMARCM-F000442_seg002", 
  "FruMARCM-F001929_seg001"), c("FruMARCM-M001205_seg002", "GadMARCM-F000122_seg001", 
  "GadMARCM-F000050_seg001", "GadMARCM-F000142_seg002", "FruMARCM-F000270_seg001", 
  "FruMARCM-F001115_seg002", "FruMARCM-M001051_seg002", "GadMARCM-F000423_seg001", 
  "ChaMARCM-F000586_seg002", "FruMARCM-M001339_seg001", "GadMARCM-F000476_seg001", 
  "FruMARCM-F000085_seg001", "FruMARCM-F000706_seg001", "FruMARCM-M000842_seg002", 
  "FruMARCM-F001494_seg002", "FruMARCM-F000188_seg001", "GadMARCM-F000071_seg001", 
  "FruMARCM-M000115_seg001", "GadMARCM-F000442_seg002", "FruMARCM-F001929_seg001"
  )), "`scaled:scale`" = structure(c(0.0003091628460013, 0.000295630465536596, 
  0.000234765369690826, 0.00024733027680104, 0.000237946472261163, 
  0.000218958225098177, 0.000212596242770869, 0.000211571682564745, 
  0.000210053225512845, 0.000201381303358645, 0.000193823947603464, 
  0.000192127457908904, 0.000191290301229562, 0.000192127457908904, 
  0.00018254105668268, 0.000181409603852002, 0.000177378279321958, 
  0.000184071799296371, 0.00017352222977148, 0.000179188261764018
  ), .Names = c("FruMARCM-M001205_seg002", "GadMARCM-F000122_seg001", 
  "GadMARCM-F000050_seg001", "GadMARCM-F000142_seg002", "FruMARCM-F000270_seg001", 
  "FruMARCM-F001115_seg002", "FruMARCM-M001051_seg002", "GadMARCM-F000423_seg001", 
  "ChaMARCM-F000586_seg002", "FruMARCM-M001339_seg001", "GadMARCM-F000476_seg001", 
  "FruMARCM-F000085_seg001", "FruMARCM-F000706_seg001", "FruMARCM-M000842_seg002", 
  "FruMARCM-F001494_seg002", "FruMARCM-F000188_seg001", "GadMARCM-F000071_seg001", 
  "FruMARCM-M000115_seg001", "GadMARCM-F000442_seg002", "FruMARCM-F001929_seg001"
  )))
  
  nn=rownames(scores)
  expect_equivalent(fc_subscoremat(nn,nn,scoremat=scores),scores)
  
})
