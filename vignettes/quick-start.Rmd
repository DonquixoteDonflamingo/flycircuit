<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{Quick-start guide}
-->

# Quick-start guide
Data for various neurons can be downloaded from jefferislab.org and analysed using this package. The data include information on the location of the neurons in 3D space, details on innervation in different neuropils, and NBLAST scores. This quick-start guide is designed to give a brief examples of a subset of the analyses that can be carried out using this package, using an example dataset of 20 Kenyon cells.

## Set up environment
```{r setup, message=FALSE, warning=FALSE}
# Allow production of figures using RGL
library(knitr)
knit_hooks$set(rgl = hook_rgl)
opts_chunk$set(dev=c('png','pdf'))
# sidestep a bug in knitr that fails to produce output dir for rgl snapshots
dir.create('figure')
```

### Load flycircuit and nat (NeuronAnatomy Toolbox) packages
```{r load-flycircuit}
library(flycircuit)
library(nat)
```

### Package options
By default, any remote data will be downloaded to the 'extdata' subdirectory in the package's directory tree within the R library. If you wish to save data to a different location then this can be set using: 
```{r package-options, eval=FALSE}
options(flycircuit.localroot = '/my/favourite/directory')
```
For example, you may wish to do this if you want to cluster all of the neurons in the dataset, therefore needing to download the 2 GB all by all score matrix. To download and load this matrix, you would need to run:
```{r download-huge-matrix, eval=FALSE}
fc_download_data('http://jefferislab.org/si/nblast/flycircuit/abc2.normdmat.desc', type='bigmat')
fc_attach_bigmat('abc2.normdmat')
```

## Inspect Kenyon cell NBLAST scores
The package comes with some sample NBLAST scores for a set of 20 Kenyon cells.
Each score is a pairwise comparison between two neurons. The score is asymmetric
i.e. S(A,B)!=S(B,A). See ?kcs20scores for details.

Show the scores for the first five neurons:
```{r score-peek}
kcs20scores[1:5, 1:5]
```

## Download other Kenyon cell data
At the moment we have the NBLAST scores for the Kenyon cells, but no other information about them. Let's download some.
```{r download-kc-info}
# Download the data
kcs20 <- read.neuronlistfh('http://jefferislab.org/si/nblast/flycircuit/kcs20.rds', getOption('flycircuit.datadir'))
```

Now we can plot these 20 neurons and see where they are located in the brain:
```{r plot-kcs, rgl=TRUE, dev='png'}
# set default view to frontal
r3dDefaults$userMatrix=structure(c(1, 0, 0, 0, 0, -1, 0, 0, 0, 0, -1, 0, 0, 0, 0, 1), .Dim = c(4L, 4L))
open3d()
plot3dfc(names(kcs20), db=kcs20)
fcwbsurf()
```

We'll be plotting these Kenyon cells a lot, so let's set an option that will save us some typing:
```{r option-set}
options(nat.default.neuronlist = 'kcs20')
```

## Plotting NBLAST hits
Let's plot the two neurons that NBLAST thinks are most similar.

Find the indices of the minimum score (i.e. least distance) in the score matrix:
```{r top-hits}
ind <- which(kcs20scores[, ] == min(kcs20scores[, ]), arr.ind=T)
queryneuron <- colnames(kcs20scores)[ind[2]]
targetneuron <- rownames(kcs20scores)[ind[1]]
```
What was the query?
```{r query}
queryneuron
```

What was the target?
```{r target}
targetneuron
```

What do they look like and where in the brain are they?
```{r plot-top-hits, rgl=TRUE, dev='png'}
clear3d()
plot3dfc(c(queryneuron, targetneuron), db=kcs20)
fcwbsurf()
```

## Cluster Kenyon cells by morphology
```{r cluster-kcs}
# nb this works because options(flycircuit.scoremat="kcs20scores")
# can also set the score matrix to use explicitly
# hckc <- hclustfc(rownames(kcs20scores), scoremat=kcs20scores)
hckc <- hclustfc(rownames(kcs20scores))
library(dendroextras)
plot(colour_clusters(hckc, k=3))
```

Now let's look at the neurons:

```{r rgl-cluster-kcs, rgl=TRUE, dev='png'}
clear3d()
plot3d(hckc, k=3, db=kcs20)
```
Good, we can see the 3 main classes (gamma, alpha'/beta' and alpha/beta).

## More NBLASTing
We know that `r queryneuron` and `r targetneuron` are the two most similar neurons in our subset of 20 Kenyon cells, but how do other neurons compare with `r queryneuron`? Let's NBLAST it against all the other neurons and look at the scores.
```{r blasting}
results <- fc_nblast(queryneuron, names(kcs20), 'kcs20scores')
par(las=2)                # Horizontal labels
par(mar=c(5, 14, 2, 2))   # Extra margin for labels
barplot(results, horiz=T)
```
Unsurprisingly, `r queryneuron` itself has the lowest score (seeing as it should have zero distance from itself). Interestingly, while `r targetneuron` has the second-lowest score, `r names(sort(results)[3])` has a similarly small score, closely followed by `r paste0(names(sort(results)[4:5]), collapse=' and ')`. Let's plot them all, with the query neuron in black, to see how similar they are:
```{r plot-good-hits, rgl=TRUE, dev='png'}
clear3d()
plot3d(queryneuron, col='black')
plot3dfc(names(sort(results,decreasing=TRUE)[2:5]))
```
Hmm, they look pretty similar. Let's plot the four worst hits for comparison:
```{r plot-bad-hits, rgl=TRUE, dev='png'}
clear3d()
plot3d(queryneuron, col='black')
plot3dfc(names(sort(results)[1:4]))
```
Definitely different.
